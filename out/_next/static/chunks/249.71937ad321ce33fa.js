"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[249],{13249:(e,t,l)=>{l.r(t),l.d(t,{default:()=>N});var a=l(95155),r=l(12115),s=l(30310);let i=r.memo(e=>{let{width:t,height:l,gridSize:r=50,scale:i,x:n,y:o,visible:c=!0}=e;if(!c)return null;let d=((e,t)=>e<.15?8*t:e<.3?4*t:e<.6?2*t:t)(i,r),u=[],x=Math.min(200,.1*t),h=Math.floor((-n-x)/(d*i))*d,g=Math.ceil((t-n+x)/(d*i))*d,m=Math.floor((-o-x)/(d*i))*d,f=Math.ceil((l-o+x)/(d*i))*d;if(Math.abs(g-h)/d+Math.abs(f-m)/d>200)return null;for(let e=h;e<=g;e+=d){let t=e%(5*d)==0;u.push((0,a.jsx)(s.N1,{points:[e,m,e,f],stroke:t?"#94a3b8":"#e2e8f0",strokeWidth:t?1:.5,listening:!1,perfectDrawEnabled:!1},"v-".concat(e)))}for(let e=m;e<=f;e+=d){let t=e%(5*d)==0;u.push((0,a.jsx)(s.N1,{points:[h,e,g,e],stroke:t?"#94a3b8":"#e2e8f0",strokeWidth:t?1:.5,listening:!1,perfectDrawEnabled:!1},"h-".concat(e)))}return(0,a.jsx)(s.YJ,{listening:!1,children:u})},(e,t)=>e.width===t.width&&e.height===t.height&&e.gridSize===t.gridSize&&e.scale===t.scale&&e.x===t.x&&e.y===t.y&&e.visible===t.visible);var n=l(24879),o=l(20215);let c=r.memo(e=>{let{equipment:t,equipmentDefinitions:l,scale:r,onEquipmentSelect:i,onEquipmentMove:c,onEquipmentRotate:d,onEquipmentDelete:u,selectedEquipmentId:x,snapToGrid:h=!0,gridSize:g=10}=e,m=l||n.ge;return(0,a.jsx)(s.YJ,{children:t.map(e=>{let t=m.find(t=>t.id===e.equipmentId);if(!t)return null;let l=x===e.id,n=e.dimensions,f="circle"===n.shape,b=f?2*n.radius*10:10*n.width,p=f?2*n.radius*10:10*n.height,y=f?10*n.radius:0;return(0,a.jsxs)(s.YJ,{x:e.x,y:e.y,rotation:e.rotation,offsetX:f?y:b/2,offsetY:f?y:p/2,draggable:!0,onClick:t=>((e,t)=>{t&&(t.cancelBubble=!0),null==i||i(e)})(e,t),onDragEnd:t=>((e,t)=>{let{x:l,y:a}=((e,t)=>h?{x:Math.round(e/g)*g,y:Math.round(t/g)*g}:{x:e,y:t})(t.target.x(),t.target.y());t.target.x(l),t.target.y(a),null==c||c(e,l,a)})(e.id,t),onKeyDown:t=>((e,t)=>{("Delete"===t.evt.key||"Backspace"===t.evt.key)&&(t.evt.preventDefault(),null==u||u(e))})(e.id,t),tabIndex:0,children:[f?(0,a.jsx)(s.jl,{x:0,y:0,radius:y,fill:t.color,stroke:l?"#2563eb":"#666666",strokeWidth:l?3:1,opacity:.8}):(0,a.jsx)(s.rw,{x:-b/2,y:-p/2,width:b,height:p,fill:t.color,stroke:l?"#2563eb":"#666666",strokeWidth:l?3:1,opacity:.8,cornerRadius:2}),(0,a.jsx)(s.EY,{text:e.customLabel||t.name,x:f?-y+2:-b/2+2,y:f?-6:-p/2+2,fontSize:Math.max(10,12/r),fill:l?"#2563eb":"#000000",fontFamily:"Arial",fontStyle:"bold",wrap:"word",width:f?2*y-4:b-4,height:f?12:p-4,align:"center",verticalAlign:"middle",listening:!1}),(()=>{let l=e.clearance;if(!l&&t.rideClearing&&t.rideClearing>0&&(l=(0,o.U7)(n,t.rideClearing)),console.log("EquipmentLayer - clearance rendering:",{equipmentId:e.id,equipmentName:t.name,placedEquipmentClearance:e.clearance,finalClearance:l,clearanceType:null==l?void 0:l.type,hasCustomClearance:(null==l?void 0:l.type)==="custom"}),!l)return null;if("custom"===l.type){let t=(0,o.Lt)(l);if(console.log("EquipmentLayer - custom clearance details:",{clearanceData:l,polygonPointsCount:t.length,polygonPoints:t,pixelsPerFoot:10,equipmentPosition:{x:e.x,y:e.y},equipmentRotation:e.rotation}),t.length<3)return console.log("EquipmentLayer - insufficient polygon points:",t.length),null;let r=t.flatMap(e=>[10*e.x-(f?y:b/2),10*e.y-(f?y:p/2)]);return console.log("EquipmentLayer - rendering custom clearance Line with pixelPoints:",r),(0,a.jsx)(s.N1,{points:r,closed:l.closed,fill:"rgba(255, 0, 255, 0.3)",stroke:"#ff00ff",strokeWidth:4,dash:[10,5],opacity:1,listening:!1})}{var r,i,c,d,u,x,h,g;let e=null!=(i=null!=(r=l.front)?r:l.all)?i:0,t=null!=(d=null!=(c=l.back)?c:l.all)?d:0,n=null!=(x=null!=(u=l.left)?u:l.all)?x:0,o=null!=(g=null!=(h=l.right)?h:l.all)?g:0;return 0===e&&0===t&&0===n&&0===o?null:f?(0,a.jsx)(s.jl,{radius:y+10*Math.max(e,t,n,o),fill:"rgba(255, 165, 0, 0.1)",stroke:"#ff8c00",strokeWidth:2,dash:[8,4],opacity:.6,listening:!1}):(0,a.jsx)(s.rw,{x:-b/2-10*n,y:-p/2-10*e,width:b+(n+o)*10,height:p+(e+t)*10,fill:"rgba(255, 165, 0, 0.1)",stroke:"#ff8c00",strokeWidth:2,dash:[8,4],opacity:.6,listening:!1})}})(),l&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(s.rw,{x:f?y-4:b/2-4,y:f?y-4:p/2-4,width:8,height:8,fill:"#2563eb",stroke:"#ffffff",strokeWidth:1,draggable:!1}),(0,a.jsxs)(s.YJ,{children:[(0,a.jsx)(s.jl,{x:0,y:f?-y-15:-p/2-15,radius:6,fill:"#10b981",stroke:"#ffffff",strokeWidth:1,draggable:!0,onDragMove:t=>{var l,a;let r=t.target.getStage();if(!r)return;let s=r.getPointerPosition();if(!s)return;let i=null==(l=t.target.getParent())?void 0:l.getParent();if(!i)return;let n=i.x(),o=i.y(),c=180*Math.atan2(s.y-o,s.x-n)/Math.PI+90;a=e.id,null==d||d(a,c),t.target.x(0),t.target.y(f?-y-15:-p/2-15)}}),(0,a.jsx)(s.rw,{x:-.5,y:f?-y-20:-p/2-20,width:1,height:20,fill:"#10b981",listening:!1})]}),(0,a.jsx)(s.rw,{x:f?y-6:b/2-6,y:f?-y-6:-p/2-6,width:12,height:12,fill:"#ef4444",stroke:"#ffffff",strokeWidth:1,cornerRadius:2,onClick:t=>{t.cancelBubble=!0,null==u||u(e.id)}}),(0,a.jsx)(s.EY,{x:f?y-3:b/2-3,y:f?-y-3:-p/2-3,text:"\xd7",fontSize:8,fill:"white",align:"center",listening:!1})]})]},e.id)})})},(e,t)=>e.equipment.length===t.equipment.length&&e.scale===t.scale&&e.selectedEquipmentId===t.selectedEquipmentId&&e.snapToGrid===t.snapToGrid&&e.gridSize===t.gridSize&&e.equipment.every((e,l)=>{let a=t.equipment[l];return e.id===a.id&&e.x===a.x&&e.y===a.y&&e.rotation===a.rotation&&e.equipmentId===a.equipmentId}));var d=l(55003),u=l.n(d);let x=e=>{let{images:t,onImageUpdate:l,onImageDelete:i,onImageSelect:n,selectedImageId:o,scale:c,editable:d=!0,measurementToolActive:x=!1}=e,[h,g]=(0,r.useState)(new Map),[m,f]=(0,r.useState)(new Set);(0,r.useEffect)(()=>{let e=async()=>{let e=new Map;for(let l of t){if(m.has(l.id)){console.warn("Skipping previously failed image: ".concat(l.id));continue}if(h.has(l.id))e.set(l.id,h.get(l.id));else try{let t=new window.Image;t.crossOrigin="anonymous",await new Promise((e,a)=>{let r=setTimeout(()=>{a(Error("Image load timeout"))},1e4);t.onload=()=>{clearTimeout(r),e()},t.onerror=e=>{clearTimeout(r),a(e)},t.src=l.url}),e.set(l.id,t)}catch(e){console.error("Failed to load background image ".concat(l.id,":"),e),f(e=>new Set([...e,l.id]));continue}}(e.size!==h.size||Array.from(e.keys()).some(e=>!h.has(e)))&&g(e)};t.length>0&&e()},[t]);let b=e=>{d&&(null==n||n(e))};return(0,a.jsx)(s.YJ,{children:t.map(e=>{let t=h.get(e.id);return t&&e.visible?(e.id,(0,a.jsxs)(s.YJ,{children:[(0,a.jsx)(s._V,{image:t,x:e.x,y:e.y,width:e.width,height:e.height,scaleX:e.scaleX,scaleY:e.scaleY,rotation:e.rotation,opacity:e.locked?.8*e.opacity:e.opacity,draggable:d&&!e.locked,onClick:()=>b(e.id),onTap:()=>b(e.id),onDragEnd:t=>((e,t)=>{let a=t.target;null==l||l(e,{x:a.x(),y:a.y()})})(e.id,t),onTransformEnd:t=>((e,t)=>{let a=t.target;null==l||l(e,{x:a.x(),y:a.y(),scaleX:a.scaleX(),scaleY:a.scaleY(),rotation:a.rotation(),width:a.width()*a.scaleX(),height:a.height()*a.scaleY()})})(e.id,t),listening:d&&!x,filters:e.locked?[u().Filters.Grayscale]:void 0}),e.locked&&(0,a.jsxs)(s.YJ,{x:e.x+e.width*e.scaleX-40,y:e.y+10,rotation:e.rotation,children:[(0,a.jsx)(s.rw,{width:30,height:30,fill:"rgba(239, 68, 68, 0.9)",stroke:"#ffffff",strokeWidth:2,cornerRadius:4,shadowColor:"black",shadowBlur:4,shadowOpacity:.3}),(0,a.jsx)(s.EY,{x:6,y:6,text:"\uD83D\uDD12",fontSize:18,fill:"white"})]}),e.locked&&(0,a.jsx)(s.rw,{x:e.x,y:e.y,width:e.width,height:e.height,scaleX:e.scaleX,scaleY:e.scaleY,rotation:e.rotation,stroke:"#ef4444",strokeWidth:3/c,dash:[10,5],listening:!1})]},e.id)):null})})};function h(e){try{let t=new URL(e),l=e.match(/@(-?\d+\.?\d*),(-?\d+\.?\d*),(\d+\.?\d*)z/);if(l)return{latitude:parseFloat(l[1]),longitude:parseFloat(l[2]),zoom:parseFloat(l[3])};let a=e.match(/q=(-?\d+\.?\d*),(-?\d+\.?\d*)/),r=e.match(/z=(\d+)/);if(a)return{latitude:parseFloat(a[1]),longitude:parseFloat(a[2]),zoom:r?parseFloat(r[1]):18};let s=e.match(/@(-?\d+\.?\d*),(-?\d+\.?\d*),(\d+\.?\d*)/);if(s)return{latitude:parseFloat(s[1]),longitude:parseFloat(s[2]),zoom:parseFloat(s[3])};let i=t.searchParams,n=i.get("lat")||i.get("latitude"),o=i.get("lng")||i.get("longitude"),c=i.get("z")||i.get("zoom");if(n&&o)return{latitude:parseFloat(n),longitude:parseFloat(o),zoom:c?parseFloat(c):18};return null}catch(e){return console.error("Error parsing Google Maps URL:",e),null}}function g(e,t,l){let a,r,s,i,n,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"standard",c=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"square",d=arguments.length>5&&void 0!==arguments[5]?arguments[5]:2,u={standard:{size:640,scale:1},high:{size:1280,scale:1},ultra:{size:2048,scale:2}}[o];switch(a=Math.min(u.size,2048),console.log("\uD83C\uDFAF SATELLITE IMAGE QUALITY DEBUG:",{requestedQuality:o,isPremium:!0,maxApiSize:a,scaleValue:r=u.scale,resultingResolution:"".concat(a,"x").concat(a),scaleMultiplier:r,effectiveResolution:"".concat(a*r,"x").concat(a*r)}),c){case"landscape":s=a,i=Math.floor(a/2);break;case"wide":s=a,i=Math.floor(a/3);break;case"portrait":s=Math.floor(a/2),i=a;break;default:s=a,i=a}console.log("\uD83D\uDCD0 ASPECT RATIO: ".concat(c," → ").concat(s,"\xd7").concat(i," pixels")),s=Math.min(s,2048),i=Math.min(i,2048);let x=1e3*d,h=.3048*x;console.log("\uD83D\uDDFA️ COVERAGE EXPANSION: ".concat(d,"x → ").concat(x,"' \xd7 ").concat(1e3*d,"' area"));let g=Math.max(1,Math.min(20,Math.round(Math.log2(0x2637f09*Math.cos(e*Math.PI/180)/(h/Math.max(s,i)*256))-1))),m=0x2637f09*Math.cos(e*Math.PI/180)/Math.pow(2,g+8),f=m/.3048,b=1/f,p=s*f,y=i*f,w="AIzaSyAdI4z3OkycXyetVJUmACZyQJyTYyMMUXs";if(w){let l=r>1?"&scale=".concat(r):"";console.log("\uD83D\uDE80 FINAL IMAGE URL:",{url:n="https://maps.googleapis.com/maps/api/staticmap?center=".concat(e,",").concat(t,"&zoom=").concat(g,"&size=").concat(s,"x").concat(i,"&maptype=satellite").concat(l,"&key=").concat(w),hasScaleParam:""!==l,actualResolution:l?"".concat(s*r,"x").concat(i*r):"".concat(s,"x").concat(i)})}else{let a='\n      <svg width="'.concat(s,'" height="').concat(i,'" xmlns="http://www.w3.org/2000/svg">\n        <rect width="100%" height="100%" fill="#e5e7eb"/>\n        <text x="50%" y="40%" text-anchor="middle" font-family="Arial" font-size="16" fill="#374151">\n          Satellite Image Placeholder\n        </text>\n        <text x="50%" y="50%" text-anchor="middle" font-family="Arial" font-size="14" fill="#6b7280">\n          Location: ').concat(e.toFixed(6),", ").concat(t.toFixed(6),'\n        </text>\n        <text x="50%" y="60%" text-anchor="middle" font-family="Arial" font-size="14" fill="#6b7280">\n          Zoom: ').concat(l," | Scale: ").concat(f.toFixed(2)," ft/px\n        </text>\n      </svg>\n    ");n="data:image/svg+xml,".concat(encodeURIComponent(a))}return{imageUrl:n,scale:b,centerLat:e,centerLng:t,widthMeters:s*m,heightMeters:i*m,widthFeet:p,heightFeet:y}}function m(e){try{let t=new URL(e).hostname.toLowerCase();return t.includes("google.com")||t.includes("maps.google.com")||t.includes("goo.gl")}catch(e){return!1}}function f(e){let{onImport:t,onClose:l}=e,[s,i]=(0,r.useState)(""),[n,o]=(0,r.useState)(!1),[c,d]=(0,r.useState)(""),[u,x]=(0,r.useState)(null),f=async()=>{if(!s.trim())return void d("Please enter a Google Maps URL");if(!m(s))return void d("Please enter a valid Google Maps URL");o(!0),d("");try{let e=h(s);if(!e)throw Error("Could not parse Google Maps URL");let a=g(e.latitude,e.longitude,e.zoom,"ultra","landscape",2),r=a.imageUrl;t(r,{name:"Satellite Image - ".concat(a.centerLat.toFixed(4),", ").concat(a.centerLng.toFixed(4)),scale:a.scale,widthFeet:a.widthFeet,heightFeet:a.heightFeet,autoPositioned:!0,googleMapsData:e}),l()}catch(e){d(e instanceof Error?e.message:"Failed to import satellite image")}finally{o(!1)}};return(0,a.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:(0,a.jsxs)("div",{className:"bg-white rounded-lg shadow-xl max-w-md w-full mx-4",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between p-6 border-b",children:[(0,a.jsx)("h2",{className:"text-xl font-semibold text-gray-900",children:"Import from Google Maps"}),(0,a.jsx)("button",{onClick:l,className:"absolute top-4 right-4 text-gray-500 hover:text-gray-700",title:"Close",children:"✕"})]}),(0,a.jsxs)("div",{className:"p-6",children:[(0,a.jsxs)("div",{className:"mb-4",children:[(0,a.jsx)("label",{htmlFor:"maps-url",className:"block text-sm font-medium text-gray-700 mb-2",children:"Google Maps URL"}),(0,a.jsx)("input",{id:"maps-url",type:"url",value:s,onChange:e=>{let t=e.target.value;if(i(t),d(""),x(null),t.trim()&&m(t)){let e=h(t);if(e){let t=g(e.latitude,e.longitude,e.zoom,"ultra","landscape",2);x({mapsData:e,config:t,description:"".concat(e.latitude.toFixed(6),", ").concat(e.longitude.toFixed(6)," (Zoom: ").concat(e.zoom,")")})}}},placeholder:"Paste Google Maps link here...",className:"w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-gray-900 bg-white placeholder-gray-500"}),(0,a.jsx)("p",{className:"mt-1 text-xs text-gray-500",children:"Paste a link from Google Maps (e.g., from sharing a location)"})]}),c&&(0,a.jsx)("div",{className:"mb-4 p-3 bg-red-50 border border-red-200 rounded-md",children:(0,a.jsx)("p",{className:"text-sm text-red-600",children:c})}),u&&(0,a.jsxs)("div",{className:"mb-4 p-3 bg-green-50 border border-green-200 rounded-md",children:[(0,a.jsx)("h4",{className:"text-sm font-medium text-green-800 mb-2",children:"Preview:"}),(0,a.jsx)("p",{className:"text-sm text-gray-600",children:"We'll import a satellite image for this location with the calculated scale."}),(0,a.jsxs)("p",{className:"text-sm text-green-700",children:[(0,a.jsx)("strong",{children:"Image Size:"})," ",u.config.widthFeet,"' \xd7 ",u.config.heightFeet,"'"]}),(0,a.jsxs)("p",{className:"text-sm text-green-700",children:[(0,a.jsx)("strong",{children:"Scale:"})," ",u.config.scale," pixels/foot"]})]}),(0,a.jsx)("div",{className:"bg-yellow-50 border border-yellow-200 rounded-md p-3 mb-4",children:(0,a.jsxs)("div",{className:"flex",children:[(0,a.jsx)("svg",{className:"w-5 h-5 text-yellow-400 mr-2 mt-0.5",fill:"currentColor",viewBox:"0 0 20 20",children:(0,a.jsx)("path",{fillRule:"evenodd",d:"M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z",clipRule:"evenodd"})}),(0,a.jsx)("div",{children:(0,a.jsxs)("p",{className:"text-sm text-yellow-700",children:[(0,a.jsx)("strong",{children:"Note:"})," This demo uses a placeholder image. In production, you would need a Google Maps API key to fetch actual satellite imagery."]})})]})})]}),(0,a.jsxs)("div",{className:"flex justify-end space-x-3 px-6 py-4 border-t bg-gray-50",children:[(0,a.jsx)("button",{onClick:l,className:"px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 focus:ring-2 focus:ring-blue-500 focus:ring-offset-2",children:"Cancel"}),(0,a.jsx)("button",{onClick:f,disabled:n||!u,className:"px-4 py-2 text-sm font-medium text-white bg-blue-600 border border-transparent rounded-md hover:bg-blue-700 focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed",children:n?"Importing...":"Import Satellite Image"})]})]})})}let b=e=>{let{images:t,onImageAdd:l,onImageUpdate:s,onImageDelete:i,onImageSelect:n,selectedImageId:o,isOpen:c,onClose:d}=e,[u,x]=(0,r.useState)(!1),[h,g]=(0,r.useState)(!1),[m,b]=(0,r.useState)(!1),p=(0,r.useRef)(null),y=(0,r.useCallback)(e=>{e.preventDefault(),e.stopPropagation(),"dragenter"===e.type||"dragover"===e.type?x(!0):"dragleave"===e.type&&x(!1)},[]),w=(0,r.useCallback)(e=>{e.preventDefault(),e.stopPropagation(),x(!1),e.dataTransfer.files&&e.dataTransfer.files[0]&&j(e.dataTransfer.files)},[]),j=async e=>{g(!0);for(let t=0;t<e.length;t++){let a=e[t];if(!a.type.startsWith("image/")){alert("".concat(a.name," is not an image file"));continue}if(a.size>0x3200000){alert("".concat(a.name," is too large. Maximum size is 50MB"));continue}try{let e=URL.createObjectURL(a),t=new Image;await new Promise((l,a)=>{t.onload=()=>l(),t.onerror=a,t.src=e});let r={name:a.name,url:e,x:0,y:0,width:t.naturalWidth,height:t.naturalHeight,scaleX:1,scaleY:1,rotation:0,opacity:.7,visible:!0,locked:!1};l(r)}catch(e){console.error("Failed to load image ".concat(a.name,":"),e),alert("Failed to load image ".concat(a.name))}}g(!1)},v=t.find(e=>e.id===o);return c?(0,a.jsxs)("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:[(0,a.jsxs)("div",{className:"bg-white rounded-lg shadow-xl w-full max-w-4xl h-full max-h-[90vh] flex flex-col",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between p-4 border-b",children:[(0,a.jsx)("h2",{className:"text-xl font-semibold",children:"Background Images"}),(0,a.jsx)("button",{onClick:d,className:"text-gray-500 hover:text-gray-700 text-2xl",children:"\xd7"})]}),(0,a.jsxs)("div",{className:"flex flex-1 overflow-hidden",children:[(0,a.jsxs)("div",{className:"w-1/2 border-r flex flex-col",children:[(0,a.jsx)("div",{className:"p-4 border-b",children:(0,a.jsxs)("div",{className:"border-2 border-dashed rounded-lg p-6 text-center transition-colors ".concat(u?"border-blue-500 bg-blue-50":"border-gray-300 hover:border-gray-400"),onDragEnter:y,onDragLeave:y,onDragOver:y,onDrop:w,children:[(0,a.jsx)("input",{ref:p,type:"file",multiple:!0,accept:"image/*",onChange:e=>{e.target.files&&j(e.target.files)},className:"hidden"}),h?(0,a.jsxs)("div",{className:"text-blue-600",children:[(0,a.jsx)("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-2"}),"Uploading images..."]}):(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("div",{className:"text-gray-600 mb-2",children:"Drag & drop images here or"}),(0,a.jsxs)("div",{className:"flex space-x-2",children:[(0,a.jsx)("button",{onClick:()=>{var e;return null==(e=p.current)?void 0:e.click()},className:"px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600",children:"Browse Files"}),(0,a.jsxs)("button",{onClick:()=>b(!0),className:"px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 flex items-center space-x-2",children:[(0,a.jsx)("svg",{className:"w-4 h-4",fill:"currentColor",viewBox:"0 0 20 20",children:(0,a.jsx)("path",{fillRule:"evenodd",d:"M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z",clipRule:"evenodd"})}),(0,a.jsx)("span",{children:"Import from Google Maps"})]})]}),(0,a.jsx)("div",{className:"text-xs text-gray-500 mt-2",children:"Upload files or import satellite imagery from Google Maps"})]})]})}),(0,a.jsx)("div",{className:"flex-1 overflow-y-auto p-4",children:0===t.length?(0,a.jsx)("div",{className:"text-center text-gray-500 py-8",children:"No background images uploaded yet"}):(0,a.jsx)("div",{className:"space-y-2",children:t.map(e=>(0,a.jsx)("div",{className:"p-3 border rounded-lg cursor-pointer transition-colors ".concat(o===e.id?"border-blue-500 bg-blue-50":"border-gray-200 hover:border-gray-300"),onClick:()=>n(e.id),children:(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,a.jsx)("div",{className:"font-medium text-sm truncate",children:e.name}),(0,a.jsxs)("div",{className:"text-xs text-gray-500",children:[Math.round(e.width)," \xd7 ",Math.round(e.height)," px"]})]}),(0,a.jsxs)("div",{className:"flex items-center gap-2 ml-2",children:[(0,a.jsx)("button",{onClick:t=>{t.stopPropagation(),s(e.id,{visible:!e.visible})},className:"p-1 rounded ".concat(e.visible?"text-blue-600 hover:bg-blue-100":"text-gray-400 hover:bg-gray-100"),title:e.visible?"Hide":"Show",children:e.visible?"\uD83D\uDC41️":"\uD83D\uDC41️‍\uD83D\uDDE8️"}),(0,a.jsx)("button",{onClick:t=>{t.stopPropagation(),s(e.id,{locked:!e.locked})},className:"p-1 rounded ".concat(e.locked?"text-red-600 hover:bg-red-100":"text-gray-400 hover:bg-gray-100"),title:e.locked?"Unlock":"Lock",children:e.locked?"\uD83D\uDD12":"\uD83D\uDD13"}),(0,a.jsx)("button",{onClick:t=>{t.stopPropagation(),confirm("Delete ".concat(e.name,"?"))&&i(e.id)},className:"p-1 text-red-600 hover:bg-red-100 rounded",title:"Delete",children:"\uD83D\uDDD1️"})]})]})},e.id))})})]}),(0,a.jsx)("div",{className:"w-1/2 p-4 overflow-y-auto",children:v?(0,a.jsxs)("div",{className:"space-y-4",children:[(0,a.jsx)("h3",{className:"font-semibold text-lg",children:"Image Properties"}),(0,a.jsx)("div",{className:"border rounded-lg p-4",children:(0,a.jsx)("img",{src:v.url,alt:v.name,className:"max-w-full max-h-32 object-contain mx-auto"})}),(0,a.jsxs)("div",{className:"space-y-3",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium mb-1",children:"Name"}),(0,a.jsx)("input",{type:"text",value:v.name,onChange:e=>s(v.id,{name:e.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-gray-900 bg-white placeholder-gray-500"})]}),(0,a.jsxs)("div",{className:"grid grid-cols-2 gap-3",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium mb-1",children:"X Position"}),(0,a.jsx)("input",{type:"number",value:Math.round(v.x||0),onChange:e=>s(v.id,{x:Number(e.target.value)}),className:"w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-gray-900 bg-white placeholder-gray-500"})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium mb-1",children:"Y Position"}),(0,a.jsx)("input",{type:"number",value:Math.round(v.y||0),onChange:e=>s(v.id,{y:Number(e.target.value)}),className:"w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-gray-900 bg-white placeholder-gray-500"})]})]}),(0,a.jsxs)("div",{className:"grid grid-cols-2 gap-3",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium mb-1",children:"Width"}),(0,a.jsx)("input",{type:"number",value:Math.round(v.width||0),onChange:e=>s(v.id,{width:Number(e.target.value)}),className:"w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-gray-900 bg-white placeholder-gray-500"})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium mb-1",children:"Height"}),(0,a.jsx)("input",{type:"number",value:Math.round(v.height||0),onChange:e=>s(v.id,{height:Number(e.target.value)}),className:"w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-gray-900 bg-white placeholder-gray-500"})]})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium mb-1",children:"Rotation (degrees)"}),(0,a.jsx)("input",{type:"number",value:Math.round(v.rotation||0),onChange:e=>s(v.id,{rotation:Number(e.target.value)}),className:"w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-gray-900 bg-white placeholder-gray-500"})]}),(0,a.jsxs)("div",{children:[(0,a.jsxs)("label",{className:"block text-sm font-medium mb-1",children:["Opacity (",Math.round(100*(v.opacity||0)),"%)"]}),(0,a.jsx)("input",{type:"range",min:"0",max:"1",step:"0.1",value:v.opacity||0,onChange:e=>s(v.id,{opacity:Number(e.target.value)}),className:"w-full"})]}),(0,a.jsxs)("div",{className:"border border-gray-200 rounded-lg p-3 bg-gray-50",children:[(0,a.jsx)("h4",{className:"font-medium text-gray-900 mb-2",children:"Image Controls"}),(0,a.jsxs)("div",{className:"space-y-3",children:[(0,a.jsx)("div",{className:"flex items-center justify-between",children:(0,a.jsxs)("label",{className:"flex items-center cursor-pointer",children:[(0,a.jsx)("input",{type:"checkbox",checked:v.visible,onChange:e=>s(v.id,{visible:e.target.checked}),className:"mr-3 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"}),(0,a.jsxs)("span",{className:"flex items-center",children:[(0,a.jsx)("span",{className:"mr-2",children:v.visible?"\uD83D\uDC41️":"\uD83D\uDE48"}),(0,a.jsx)("span",{className:"text-sm font-medium",children:"Visible"})]})]})}),(0,a.jsx)("div",{className:"flex items-center justify-between",children:(0,a.jsxs)("label",{className:"flex items-center cursor-pointer",children:[(0,a.jsx)("input",{type:"checkbox",checked:v.locked,onChange:e=>s(v.id,{locked:e.target.checked}),className:"mr-3 h-4 w-4 text-red-600 focus:ring-red-500 border-gray-300 rounded"}),(0,a.jsxs)("span",{className:"flex items-center",children:[(0,a.jsx)("span",{className:"mr-2",children:v.locked?"\uD83D\uDD12":"\uD83D\uDD13"}),(0,a.jsx)("span",{className:"text-sm font-medium ".concat(v.locked?"text-red-700":"text-gray-700"),children:v.locked?"Locked (Cannot Move)":"Unlocked (Can Move)"})]})]})}),v.locked&&(0,a.jsx)("div",{className:"bg-red-50 border border-red-200 rounded p-2",children:(0,a.jsx)("p",{className:"text-xs text-red-700",children:"\uD83D\uDD12 This image is locked and cannot be moved or resized on the canvas. Uncheck “Locked” to make changes."})})]})]})]}),(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsx)("h4",{className:"font-medium",children:"Quick Actions"}),(0,a.jsxs)("div",{className:"grid grid-cols-2 gap-2",children:[(0,a.jsx)("button",{onClick:()=>s(v.id,{scaleX:1,scaleY:1,width:v.width/v.scaleX,height:v.height/v.scaleY}),className:"px-3 py-2 bg-gray-100 hover:bg-gray-200 rounded text-sm",children:"Reset Scale"}),(0,a.jsx)("button",{onClick:()=>s(v.id,{rotation:0}),className:"px-3 py-2 bg-gray-100 hover:bg-gray-200 rounded text-sm",children:"Reset Rotation"}),(0,a.jsx)("button",{onClick:()=>s(v.id,{x:0,y:0}),className:"px-3 py-2 bg-gray-100 hover:bg-gray-200 rounded text-sm",children:"Reset Position"}),(0,a.jsx)("button",{onClick:()=>s(v.id,{opacity:.7}),className:"px-3 py-2 bg-gray-100 hover:bg-gray-200 rounded text-sm",children:"Reset Opacity"})]})]})]}):(0,a.jsx)("div",{className:"text-center text-gray-500 py-8",children:"Select an image to view properties"})})]})]}),m&&(0,a.jsx)(f,{onImport:(e,t)=>{l({url:e,name:t.name||"Google Maps Satellite",x:0,y:0,scaleX:1,scaleY:1,rotation:0,opacity:.7,visible:!0,locked:!1,width:10*t.widthFeet,height:10*t.heightFeet}),b(!1)},onClose:()=>b(!1)})]}):null};function p(e){let t,l,{scale:r,canvasWidth:i,canvasHeight:n,pixelsPerFoot:o}=e,c=20/r,d=(n-20-40)/r,u=200/r/o;u<=50?(t=50,l=5):u<=100?(t=100,l=4):u<=200?(t=200,l=4):u<=500?(t=500,l=5):(t=100*Math.ceil(u/100),l=4);let x=t*o/r,h=x/l,g=[],m=[];for(let e=0;e<=l;e++){let i=c+e*h,n=t/l*e;g.push((0,a.jsx)(s.N1,{points:[i,d,i,d-12/r],stroke:"#333",strokeWidth:1/r},"tick-".concat(e))),m.push((0,a.jsx)(s.EY,{x:i,y:d-17/r,text:"".concat(n,"'"),fontSize:10/r,fill:"#333",align:"center",offsetX:10/r},"label-".concat(e)))}return(0,a.jsxs)(s.YJ,{children:[(0,a.jsx)(s.rw,{x:c-10/r,y:d-32/r,width:x+20/r,height:42/r,fill:"rgba(255, 255, 255, 0.9)",stroke:"#ccc",strokeWidth:1/r,cornerRadius:4/r}),(0,a.jsx)(s.rw,{x:c,y:d-8/r,width:x,height:8/r,fill:"#333"}),Array.from({length:l},(e,t)=>(0,a.jsx)(s.rw,{x:c+t*h,y:d-8/r,width:h,height:8/r,fill:t%2==0?"#333":"#fff",stroke:"#333",strokeWidth:.5/r},"segment-".concat(t))),g,m,(0,a.jsx)(s.EY,{x:c+x/2,y:d+15/r,text:"Scale",fontSize:12/r,fill:"#333",align:"center",fontStyle:"bold",offsetX:15/r})]})}function y(e){let{isActive:t,scale:l,pixelsPerFoot:i,onMeasurementComplete:n,onShowDistanceInput:o}=e,[c,d]=(0,r.useState)([]),[u,x]=(0,r.useState)(null),[h,g]=(0,r.useState)(null),[m,f]=(0,r.useState)(!1),[b,p]=(0,r.useState)(""),y=r.useCallback((e,t)=>{let l=t.x-e.x,a=t.y-e.y;return Math.sqrt(l*l+a*a)/i},[i]),w=function(e,t,r,i,n){let o=arguments.length>5&&void 0!==arguments[5]&&arguments[5],c=(e.x+t.x)/2,d=(e.y+t.y)/2,u=o?"#ff6b6b":n&&Math.abs(n-1)>.1?"#ffa500":"#4dabf7";return(0,a.jsxs)(s.YJ,{children:[(0,a.jsx)(s.N1,{points:[e.x,e.y,t.x,t.y],stroke:u,strokeWidth:2/l,dash:[5/l,5/l]}),(0,a.jsx)(s.jl,{x:e.x,y:e.y,radius:4/l,fill:u,stroke:"#fff",strokeWidth:1/l}),(0,a.jsx)(s.jl,{x:t.x,y:t.y,radius:4/l,fill:u,stroke:"#fff",strokeWidth:1/l}),(0,a.jsx)(s.rw,{x:c-40/l,y:d-15/l,width:80/l,height:30/l,fill:"rgba(255, 255, 255, 0.9)",stroke:u,strokeWidth:1/l,cornerRadius:4/l}),(0,a.jsx)(s.EY,{x:c,y:d-8/l,text:"Calc: ".concat(r.toFixed(1),"'"),fontSize:10/l,fill:"#333",align:"center",offsetX:25/l}),i&&(0,a.jsx)(s.EY,{x:c,y:d+2/l,text:"Real: ".concat(i.toFixed(1),"'"),fontSize:10/l,fill:"#333",align:"center",offsetX:25/l})]},o?"temp":"".concat(e.x,"-").concat(e.y))};return(0,a.jsxs)(s.YJ,{children:[t&&(0,a.jsx)(s.rw,{x:0,y:0,width:1e4,height:1e4,fill:"transparent",onClick:e=>{if(!t)return;let l=e.target.getStage();if(!l)return;let a=l.getPointerPosition();if(a)if(u){let e={x:a.x,y:a.y},t=y(u,e);t>5&&o&&o(t,l=>{let a={id:"measurement-".concat(Date.now()),start:u,end:e,calculatedDistance:t,actualDistance:l,scaleAccuracy:l/t};d(e=>[...e,a]),null==n||n(a)},()=>{}),x(null)}else x({x:a.x,y:a.y})},listening:!0}),c.map((e,t)=>w(e.start,e.end,e.calculatedDistance,e.actualDistance,e.scaleAccuracy,!1)),u&&(0,a.jsx)(s.jl,{x:u.x,y:u.y,radius:6/l,fill:"#ff6b6b",stroke:"#fff",strokeWidth:2/l}),h&&w(h.start,h.end,h.calculatedDistance,void 0,void 0,!0),m&&h&&(0,a.jsxs)(s.YJ,{children:[(0,a.jsx)(s.rw,{x:h.end.x+20/l,y:h.end.y-40/l,width:200/l,height:80/l,fill:"white",stroke:"#ccc",strokeWidth:1/l,cornerRadius:8/l,shadowColor:"black",shadowBlur:10,shadowOpacity:.3}),(0,a.jsx)(s.EY,{x:h.end.x+30/l,y:h.end.y-30/l,text:"Calculated: ".concat(h.calculatedDistance.toFixed(1),"'"),fontSize:12/l,fill:"#333"}),(0,a.jsx)(s.EY,{x:h.end.x+30/l,y:h.end.y-15/l,text:"Enter actual distance (feet):",fontSize:10/l,fill:"#666"})]})]})}function w(e){let{isOpen:t,calculatedDistance:l,onSubmit:s,onCancel:i}=e,[n,o]=(0,r.useState)("");if((0,r.useEffect)(()=>{t&&o("")},[t]),!t)return null;let c=n?parseFloat(n)/l:1;return(0,a.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:(0,a.jsxs)("div",{className:"bg-white rounded-lg shadow-xl max-w-md w-full mx-4 p-6",children:[(0,a.jsx)("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:"Calibrate Image Scale"}),(0,a.jsxs)("div",{className:"mb-4",children:[(0,a.jsxs)("div",{className:"bg-blue-50 border border-blue-200 rounded-md p-3 mb-4",children:[(0,a.jsxs)("p",{className:"text-sm text-blue-800",children:[(0,a.jsx)("strong",{children:"Calculated Distance:"})," ",l.toFixed(1)," feet"]}),(0,a.jsx)("p",{className:"text-xs text-blue-600 mt-1",children:"Based on current satellite image scale"})]}),(0,a.jsxs)("div",{className:"bg-green-50 border border-green-200 rounded-md p-3 mb-4",children:[(0,a.jsxs)("p",{className:"text-sm text-green-800",children:[(0,a.jsx)("strong",{children:"Auto-Calibration:"})," The satellite image scale will be automatically adjusted to match your measurement."]}),(0,a.jsx)("p",{className:"text-xs text-green-600 mt-1",children:"This ensures all future measurements and equipment placement will be precisely scaled."})]}),(0,a.jsxs)("form",{onSubmit:e=>{e.preventDefault();let t=parseFloat(n);if(isNaN(t)||t<=0)return void alert("Please enter a valid distance in feet");s(t)},children:[(0,a.jsx)("label",{htmlFor:"actualDistance",className:"block text-sm font-medium text-gray-700 mb-2",children:"Enter the actual real-world distance (in feet):"}),(0,a.jsx)("input",{id:"actualDistance",type:"number",step:"0.1",min:"0.1",value:n,onChange:e=>o(e.target.value),onKeyDown:e=>{"Escape"===e.key&&i()},className:"w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"e.g., 150.0",autoFocus:!0}),n&&(0,a.jsxs)("div",{className:"mt-3 p-3 rounded-md bg-blue-50 border border-blue-200",children:[(0,a.jsxs)("p",{className:"text-sm font-medium text-blue-800",children:["Calibration Factor: ",c.toFixed(3),"x"]}),(0,a.jsx)("p",{className:"text-xs mt-1 text-blue-600",children:c>1?"Image will be scaled up by ".concat(((c-1)*100).toFixed(1),"%"):c<1?"Image will be scaled down by ".concat(((1-c)*100).toFixed(1),"%"):"No scaling adjustment needed - perfect match!"})]}),(0,a.jsxs)("div",{className:"flex gap-3 mt-6",children:[(0,a.jsx)("button",{type:"submit",className:"flex-1 bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 focus:ring-2 focus:ring-blue-500 focus:ring-offset-2",children:"Calibrate Scale"}),(0,a.jsx)("button",{type:"button",onClick:i,className:"flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-400 focus:ring-2 focus:ring-gray-500 focus:ring-offset-2",children:"Cancel"})]})]})]}),(0,a.jsx)("div",{className:"text-xs text-gray-500 mt-4",children:(0,a.jsxs)("p",{children:[(0,a.jsx)("strong",{children:"Tip:"})," Measure known features like roads, buildings, or parking lots for best accuracy verification."]})})]})})}let j=e=>{let{activeTool:t,scale:l,pixelsPerFoot:i,measurements:n,onMeasurementComplete:o,onMeasurementDelete:c}=e,[d,u]=(0,r.useState)([]),[x,h]=(0,r.useState)(!1),g=(0,r.useCallback)(e=>{if(e.length<3)return 0;let t=0,l=e.length;for(let a=0;a<l;a++){let r=(a+1)%l;t+=e[a].x*e[r].y,t-=e[r].x*e[a].y}return(t=Math.abs(t)/2)/(i*i)},[i]),m=(0,r.useCallback)(e=>{if(e.length<2)return 0;let l=0;for(let t=0;t<e.length-1;t++){let a=e[t+1].x-e[t].x,r=e[t+1].y-e[t].y;l+=Math.sqrt(a*a+r*r)}if("area"===t&&e.length>2){let t=e[0].x-e[e.length-1].x,a=e[0].y-e[e.length-1].y;l+=Math.sqrt(t*t+a*a)}return l/i},[i,t]),f=(0,r.useCallback)((e,l)=>{if(!t)return;let a={x:e,y:l};if(x){let e=[...d,a];u(e),"distance"===t&&2===e.length&&p(e)}else u([a]),h(!0)},[t,x,d]),b=(0,r.useCallback)(()=>{t&&x&&!(d.length<2)&&p(d)},[t,x,d]),p=(0,r.useCallback)(e=>{let l=0,a="";switch(t){case"area":if(e.length<3)return;l=g(e),a="Area: ".concat(l.toFixed(0)," sq ft");break;case"perimeter":l=m(e),a="Perimeter: ".concat(l.toFixed(0)," ft");break;case"distance":l=m(e),a="Distance: ".concat(l.toFixed(0)," ft");break;default:return}o({id:"".concat(t,"-").concat(Date.now()),type:t,points:e,value:l,label:a,completed:!0}),u([]),h(!1)},[t,g,m,o]);return((0,r.useEffect)(()=>{window.measurementToolHandlers={handleClick:f,handleDoubleClick:b}},[f,b]),(0,r.useEffect)(()=>{t||(u([]),h(!1))},[t]),(0,r.useEffect)(()=>{let e=e=>{"Escape"===e.key&&x&&(u([]),h(!1))};if(t)return document.addEventListener("keydown",e),()=>document.removeEventListener("keydown",e)},[t,x]),t||0!==n.length)?(0,a.jsxs)(s.YJ,{children:[n.map(e=>(0,a.jsxs)(s.YJ,{children:[(0,a.jsx)(s.N1,{points:e.points.flatMap(e=>[e.x,e.y]),closed:"area"===e.type,fill:"area"===e.type?"#10B981":void 0,fillOpacity:"area"===e.type?.1:void 0,stroke:"area"===e.type?"#10B981":"perimeter"===e.type?"#3B82F6":"#F59E0B",strokeWidth:2/l,dash:"perimeter"===e.type?[4/l,4/l]:void 0}),e.points.map((t,r)=>(0,a.jsx)(s.jl,{x:t.x,y:t.y,radius:3/l,fill:"area"===e.type?"#10B981":"perimeter"===e.type?"#3B82F6":"#F59E0B",stroke:"white",strokeWidth:1/l},r)),(0,a.jsx)(s.EY,{x:e.points[0].x,y:e.points[0].y-25/l,text:e.label,fontSize:12/l,fill:"area"===e.type?"#10B981":"perimeter"===e.type?"#3B82F6":"#F59E0B",fontStyle:"bold",shadowColor:"white",shadowBlur:2,shadowOffset:{x:1,y:1}}),(0,a.jsx)(s.jl,{x:e.points[0].x+40/l,y:e.points[0].y-25/l,radius:8/l,fill:"red",opacity:.8,onClick:()=>c(e.id),onTap:()=>c(e.id)}),(0,a.jsx)(s.EY,{x:e.points[0].x+40/l,y:e.points[0].y-25/l,text:"\xd7",fontSize:10/l,fill:"white",fontStyle:"bold",align:"center",verticalAlign:"middle",offsetX:3/l,offsetY:5/l,onClick:()=>c(e.id),onTap:()=>c(e.id)})]},e.id)),x&&d.length>0&&(0,a.jsxs)(s.YJ,{children:[d.length>1&&(0,a.jsx)(s.N1,{points:d.flatMap(e=>[e.x,e.y]),closed:!1,stroke:"area"===t?"#10B981":"perimeter"===t?"#3B82F6":"#F59E0B",strokeWidth:2/l,dash:[3/l,3/l]}),d.map((e,r)=>(0,a.jsx)(s.jl,{x:e.x,y:e.y,radius:3/l,fill:"area"===t?"#10B981":"perimeter"===t?"#3B82F6":"#F59E0B",stroke:"white",strokeWidth:1/l},r)),(0,a.jsx)(s.EY,{x:d[0].x,y:d[0].y-40/l,text:"distance"===t?"Click second point to complete":d.length<("area"===t?3:2)?"Click to add points (need ".concat("area"===t?3:2," minimum)"):"Double-click to complete, ESC to cancel",fontSize:10/l,fill:"area"===t?"#10B981":"perimeter"===t?"#3B82F6":"#F59E0B",fontStyle:"bold",shadowColor:"white",shadowBlur:2,shadowOffset:{x:1,y:1}})]})]}):null},v=e=>{let{isActive:t,editMode:l,scale:i,pixelsPerFoot:n,currentMeasurement:o,onPointSet:c,onMeasurementComplete:d,onMeasurementEdit:u}=e,[x,h]=(0,r.useState)(!1),[g,m]=(0,r.useState)(null);if((0,r.useEffect)(()=>{if(!t||l)return;let e=window.enhancedMeasurementHandlers||{};return e.handleClick=e=>{let t=e.target.getStage();if(!t)return;let l=t.getPointerPosition();if(l)c({x:(l.x-t.x())/i,y:(l.y-t.y())/i})},window.enhancedMeasurementHandlers=e,()=>{window.enhancedMeasurementHandlers&&delete window.enhancedMeasurementHandlers.handleClick}},[t,l,i,c]),!o)return null;let{firstPoint:f,secondPoint:b,isComplete:p}=o,y=f&&b?((e,t)=>{let l=t.x-e.x,a=t.y-e.y;return Math.sqrt(l*l+a*a)/n})(f,b):0;return(0,a.jsxs)(s.YJ,{children:[f&&(0,a.jsx)(s.jl,{x:f.x,y:f.y,radius:8/i,fill:l?"#3b82f6":"#ef4444",stroke:"#ffffff",strokeWidth:2/i,draggable:l,onDragStart:()=>{h(!0),m("first")},onDragEnd:e=>{h(!1),m(null),b&&u({x:e.target.x(),y:e.target.y()},b)}}),b&&(0,a.jsx)(s.jl,{x:b.x,y:b.y,radius:8/i,fill:l?"#3b82f6":"#ef4444",stroke:"#ffffff",strokeWidth:2/i,draggable:l,onDragStart:()=>{h(!0),m("second")},onDragEnd:e=>{h(!1),m(null),f&&u(f,{x:e.target.x(),y:e.target.y()})}}),f&&b&&(0,a.jsx)(s.N1,{points:[f.x,f.y,b.x,b.y],stroke:l?"#3b82f6":"#ef4444",strokeWidth:3/i,dash:l?[10/i,5/i]:void 0}),f&&b&&(0,a.jsx)(s.EY,{x:(f.x+b.x)/2,y:(f.y+b.y)/2-20/i,text:o.realWorldDistance?"".concat(o.realWorldDistance.toFixed(1),"' (calibrated)"):"".concat(y.toFixed(1),"'"),fontSize:14/i,fill:l?"#3b82f6":"#ef4444",fontStyle:"bold",align:"center",offsetX:50/i}),t&&!l&&(0,a.jsx)(s.EY,{x:50,y:50,text:f?b?"Measurement complete":"Click to set second measurement point":"Click to set first measurement point",fontSize:16,fill:"#374151",fontStyle:"bold"}),l&&p&&(0,a.jsx)(s.EY,{x:50,y:50,text:"Drag the measurement points to adjust the line",fontSize:16,fill:"#3b82f6",fontStyle:"bold"})]})},k=e=>{let{isOpen:t,calculatedDistance:l,onSubmit:s,onEdit:i,onCancel:n}=e,[o,c]=(0,r.useState)("");return t?(0,a.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:(0,a.jsxs)("div",{className:"bg-white rounded-lg p-6 max-w-md w-full mx-4 shadow-xl",children:[(0,a.jsx)("h3",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Calibrate Measurement Scale"}),(0,a.jsxs)("div",{className:"mb-4",children:[(0,a.jsxs)("p",{className:"text-sm text-gray-600 mb-2",children:["Calculated distance: ",(0,a.jsxs)("span",{className:"font-medium",children:[l.toFixed(1)," feet"]})]}),(0,a.jsx)("p",{className:"text-sm text-gray-600 mb-4",children:"Enter the actual real-world distance to calibrate the scale:"}),(0,a.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,a.jsx)("input",{type:"number",value:o,onChange:e=>c(e.target.value),placeholder:"Enter distance",className:"flex-1 px-3 py-2 border border-gray-300 rounded-md text-gray-900 bg-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500",step:"0.1",min:"0",autoFocus:!0}),(0,a.jsx)("span",{className:"text-sm text-gray-600 font-medium",children:"feet"})]})]}),(0,a.jsxs)("div",{className:"flex space-x-3",children:[(0,a.jsx)("button",{onClick:()=>{i(),c("")},className:"flex-1 px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition-colors font-medium",children:"Edit"}),(0,a.jsx)("button",{onClick:()=>{let e=parseFloat(o);!isNaN(e)&&e>0&&(s(e),c(""))},disabled:!o||0>=parseFloat(o),className:"flex-1 px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors font-medium",children:"Calibrate Scale"}),(0,a.jsx)("button",{onClick:()=>{n(),c("")},className:"flex-1 px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 transition-colors font-medium",children:"Cancel"})]})]})}):null},N=e=>{let{width:t=1200,height:l=800,className:n="",onEquipmentAdd:o,placedEquipment:d=[],equipmentDefinitions:u,onEquipmentSelect:h,onEquipmentMove:g,onEquipmentRotate:m,onEquipmentDelete:f,selectedEquipmentId:N,backgroundImages:C=[],onBackgroundImageAdd:M,onBackgroundImageUpdate:S,onBackgroundImageDelete:D,onCanvasReady:F}=e,E=(0,r.useRef)(null),[P,z]=(0,r.useState)(!1),I=10*Math.sqrt(1e6),[Y,q]=(0,r.useState)({scale:.2,x:0,y:0}),[T,L]=(0,r.useState)({width:t,height:l}),[W,R]=(0,r.useState)(!0),[A,B]=(0,r.useState)(!1),[X,U]=(0,r.useState)(null),[G,O]=(0,r.useState)(!0),[J,H]=(0,r.useState)(!1),[V,Z]=(0,r.useState)([]),[_,Q]=(0,r.useState)(null),[K,$]=(0,r.useState)([]),[ee,et]=(0,r.useState)(!1),[el,ea]=(0,r.useState)(null),[er,es]=(0,r.useState)(!1),[ei,en]=(0,r.useState)(null),[eo,ec]=(0,r.useState)(!1);(0,r.useEffect)(()=>{if(P&&F){let e=setTimeout(()=>{if(E.current){let e=E.current.container();e&&(console.log("Canvas ready, calling onCanvasReady with container:",e),F(e))}},100);return()=>clearTimeout(e)}},[F,P]),(0,r.useEffect)(()=>{let e=()=>{if(E.current){let e=E.current.container(),t=e.parentElement,l=t?t.clientWidth:e.offsetWidth,a=t?t.clientHeight:e.offsetHeight;console.log("Canvas resize:",{containerWidth:l,containerHeight:a,parent:!!t}),L({width:l,height:a})}};window.addEventListener("resize",e);let t=setTimeout(e,100);return()=>{window.removeEventListener("resize",e),clearTimeout(t)}},[P]);let ed=(0,r.useCallback)(e=>{e.evt.preventDefault();let t=e.target.getStage();if(!t)return;let l=t.scaleX(),a=t.getPointerPosition();if(!a)return;let r=Math.max(.04,Math.min(5,e.evt.deltaY>0?l/1.1:1.1*l)),s={x:(a.x-t.x())/l,y:(a.y-t.y())/l},i={x:a.x-s.x*r,y:a.y-s.y*r};t.scale({x:r,y:r}),t.position(i),t.batchDraw(),q({scale:r,x:i.x,y:i.y})},[]),eu=(0,r.useCallback)(e=>{let t=e.target;q(e=>({...e,x:t.x(),y:t.y()}))},[]),ex=(0,r.useCallback)(()=>{let e=T.width/2-I/2*.2,t=T.height/2-I/2*.2;E.current&&(E.current.scale({x:.2,y:.2}),E.current.position({x:e,y:t}),E.current.batchDraw()),q({scale:.2,x:e,y:t})},[T,I]),eh=(0,r.useCallback)(()=>{if(console.log("=== FIT TO CONTENT CALLED ==="),console.log("placedEquipment:",d),!d||0===d.length){console.log("No equipment to fit to, resetting canvas"),ex();return}let e=1/0,t=-1/0,l=1/0,a=-1/0;d.forEach(r=>{let s,i,n,o,c=null==u?void 0:u.find(e=>e.id===r.equipmentId);if(!c)return;let d=r.dimensions,x="circle"===d.shape,h=10*(c.rideClearing||0);if(x){let e=10*d.radius;s=r.x-e-h,i=r.x+e+h,n=r.y-e-h,o=r.y+e+h}else{let e=10*d.width,t=10*d.height;s=r.x-e/2-h,i=r.x+e/2+h,n=r.y-t/2-h,o=r.y+t/2+h}e=Math.min(e,s),t=Math.max(t,i),l=Math.min(l,n),a=Math.max(a,o)}),e-=100,t+=100,l-=100,a+=100;let r=(e+t)/2,s=(l+a)/2,i=t-e,n=a-l,o=Math.min(T.width/i,T.height/n,2),c=T.width/2-r*o,x=T.height/2-s*o;console.log("Applying new canvas state:",{scale:o,x:c,y:x,contentBounds:{minX:e,maxX:t,minY:l,maxY:a},center:{centerX:r,centerY:s}}),E.current&&(E.current.scale({x:o,y:o}),E.current.position({x:c,y:x}),E.current.batchDraw()),q({scale:o,x:c,y:x})},[d,u,T,ex]),eg=(0,r.useCallback)(()=>{if(!E.current)return;let e=E.current,t=e.scaleX(),l=Math.min(5,1.1*t),a={x:T.width/2,y:T.height/2},r={x:(a.x-e.x())/t,y:(a.y-e.y())/t},s={x:a.x-r.x*l,y:a.y-r.y*l};e.scale({x:l,y:l}),e.position(s),e.batchDraw(),q({scale:l,x:s.x,y:s.y})},[T]),em=(0,r.useCallback)(()=>{if(!E.current)return;let e=E.current,t=e.scaleX(),l=Math.max(.04,t/1.1),a={x:T.width/2,y:T.height/2},r={x:(a.x-e.x())/t,y:(a.y-e.y())/t},s={x:a.x-r.x*l,y:a.y-r.y*l};e.scale({x:l,y:l}),e.position(s),e.batchDraw(),q({scale:l,x:s.x,y:s.y})},[T]);(0,r.useCallback)(()=>({minX:-Y.x/Y.scale-1e3,maxX:(-Y.x+T.width)/Y.scale+1e3,minY:-Y.y/Y.scale-1e3,maxY:(-Y.y+T.height)/Y.scale+1e3}),[Y.x,Y.y,Y.scale,T]),(0,r.useCallback)((e,t)=>{if(console.log("handleMeasurementToolClick called:",{x:e,y:t,activeMeasurementTool:_}),!_)return;let l=window.measurementToolHandlers;console.log("Global handlers:",l),l&&l.handleClick?(console.log("Calling handlers.handleClick"),l.handleClick(e,t)):console.log("No global handlers found")},[_]),(0,r.useCallback)((e,t)=>{if(!_)return;console.log("Double-click for measurement tool:",{x:e,y:t,activeMeasurementTool:_});let l=K.find(e=>!e.completed);if(!l||l.points.length<2)return;let a=0,r="";if("area"===_){if(l.points.length<3)return;let e=0,t=l.points,s=t.length;for(let l=0;l<s;l++){let a=(l+1)%s;e+=t[l].x*t[a].y,e-=t[a].x*t[l].y}a=(e=Math.abs(e)/2)/100,r="Area: ".concat(a.toFixed(0)," sq ft")}else if("perimeter"===_){let e=0,t=l.points;for(let l=0;l<t.length-1;l++){let a=t[l+1].x-t[l].x,r=t[l+1].y-t[l].y;e+=Math.sqrt(a*a+r*r)}if(t.length>2){let l=t[0].x-t[t.length-1].x,a=t[0].y-t[t.length-1].y;e+=Math.sqrt(l*l+a*a)}a=e/10,r="Perimeter: ".concat(a.toFixed(0)," ft")}let s={...l,value:a,label:r,completed:!0};$(e=>e.map(e=>e.id===l.id?s:e)),console.log("Measurement completed:",s)},[_,K,10]);let ef=(0,r.useCallback)(e=>{ei&&(ei.firstPoint?ei.secondPoint||(en({...ei,secondPoint:e,isComplete:!0}),e.x,ei.firstPoint.x,e.y,ei.firstPoint.y,setTimeout(()=>{ec(!0)},500)):en(t=>t?{...t,firstPoint:e}:null))},[ei,10]),eb=(0,r.useCallback)((e,t)=>{ei&&en(l=>l?{...l,firstPoint:e,secondPoint:t}:null)},[ei]),ep=(0,r.useCallback)(e=>{if(!ei||!ei.firstPoint||!ei.secondPoint)return;let t=ei.secondPoint.x-ei.firstPoint.x,l=ei.secondPoint.y-ei.firstPoint.y,a=e/(Math.sqrt(t*t+l*l)/10);en(t=>t?{...t,realWorldDistance:e}:null),C&&C.length>0&&S&&C.forEach(e=>{S(e.id,{scaleX:(e.scaleX||1)*a,scaleY:(e.scaleY||1)*a})}),ec(!1),console.log("Scale calibrated with factor:",a)},[ei,10,C,S]),ey=(0,r.useCallback)(()=>{ec(!1),es(!0)},[]),ew=(0,r.useCallback)(()=>{ec(!1),en(null),H(!1)},[]),ej=(0,r.useCallback)((e,t)=>{if(!_)return;console.log("Canvas click for measurement tool (raw):",{x:e,y:t,activeMeasurementTool:_});let l=(e-Y.x)/Y.scale,a=(t-Y.y)/Y.scale;console.log("Canvas click for measurement tool (transformed):",{canvasX:l,canvasY:a,canvasState:Y});let r={x:l,y:a};if(K.some(e=>!e.completed)){let e=K.find(e=>!e.completed);if(e){let t=[...e.points,r];if("distance"===_&&2===t.length){let l=Math.sqrt(Math.pow(t[1].x-t[0].x,2)+Math.pow(t[1].y-t[0].y,2))/10,a={...e,points:t,value:l,label:"Distance: ".concat(l.toFixed(0)," ft"),completed:!0};$(t=>t.map(t=>t.id===e.id?a:t))}else $(l=>l.map(l=>l.id===e.id?{...l,points:t}:l))}}else{let e={id:"".concat(_,"-").concat(Date.now()),type:_,points:[r],value:0,label:"",completed:!1};$(t=>[...t,e])}},[_,K,10]),ev=(0,r.useCallback)(e=>{if(e.target===e.target.getStage()){let t=e.target.getStage(),l=t.getPointerPosition();if(J&&!_&&l){l.x,Y.x,Y.scale,l.y,Y.y,Y.scale;let e=window.enhancedMeasurementHandlers;e&&e.handleClick&&e.handleClick({target:{getStage:()=>t}});return}if(_&&l)return void ej(l.x,l.y);null==h||h(null),U(null)}},[h,_,J,ej,Y]),ek=(0,r.useCallback)(e=>{if(!_)return;let t=e.target.getStage().getPointerPosition();if(t){let e=(t.x-Y.x)/Y.scale,l=(t.y-Y.y)/Y.scale;console.log("Double-click for measurement tool:",{x:e,y:l,activeMeasurementTool:_}),$(t=>{let a=t.find(e=>!e.completed);if(!a)return t;if("area"===_||"perimeter"===_){let r=[...a.points,{x:e,y:l}],s=0,i="";if("area"===_&&r.length>=3){let e=0;for(let t=0;t<r.length;t++){let l=(t+1)%r.length;e+=r[t].x*r[l].y,e-=r[l].x*r[t].y}s=Math.round((e=Math.abs(e)/2)/100),i="Area: ".concat(s.toLocaleString()," sq ft")}else if("perimeter"===_&&r.length>=2){let e=0;for(let t=0;t<r.length-1;t++){let l=r[t+1].x-r[t].x,a=r[t+1].y-r[t].y;e+=Math.sqrt(l*l+a*a)}let t=r[0].x-r[r.length-1].x,l=r[0].y-r[r.length-1].y;s=Math.round((e+=Math.sqrt(t*t+l*l))/10),i="Perimeter: ".concat(s.toLocaleString()," ft")}return console.log("Measurement completed:",{id:a.id,value:s,label:i,completed:!0}),t.map(e=>e.id===a.id?{...e,points:r,value:s,label:i,completed:!0}:e)}return t}),Q(null)}},[_,Y,10]),eN=(0,r.useCallback)(e=>{let t={...e,id:"bg-".concat(Date.now(),"-").concat(Math.random().toString(36).substr(2,9))};null==M||M(t)},[M]),eC=e=>{U(e)};return((0,r.useEffect)(()=>{z(!0)},[]),P)?(0,a.jsxs)("div",{className:"relative w-full h-full ".concat(n," flex flex-col"),children:[(0,a.jsxs)("div",{className:"absolute top-4 right-4 z-10 flex flex-col gap-2",children:[(0,a.jsx)("button",{onClick:ex,className:"px-3 py-1 bg-white border border-gray-300 rounded shadow hover:bg-gray-50 text-sm text-gray-900",title:"Reset View",children:"Reset"}),(0,a.jsx)("button",{onClick:eh,className:"px-3 py-1 bg-white border border-gray-300 rounded shadow hover:bg-gray-50 text-sm text-gray-900",title:"Fit to Content",children:"Fit"}),(0,a.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,a.jsxs)("div",{className:"flex space-x-1",children:[(0,a.jsx)("button",{onClick:eg,className:"flex-1 px-6 py-1 bg-white border border-gray-300 rounded shadow hover:bg-gray-50 text-sm text-gray-900 text-center",title:"Zoom In",children:"+"}),(0,a.jsx)("button",{onClick:em,className:"flex-1 px-6 py-1 bg-white border border-gray-300 rounded shadow hover:bg-gray-50 text-sm text-gray-900 text-center",title:"Zoom Out",children:"−"})]}),(0,a.jsxs)("div",{className:"text-sm text-gray-900 font-medium bg-white px-3 py-1 rounded border border-gray-300 shadow text-center flex items-center justify-center",children:["Zoom (",Math.round(100*Y.scale),"%)"]}),(0,a.jsx)("button",{onClick:()=>{if(!E.current)return;let e=E.current;if(C&&C.length>0){let t=0,l=0,a=null;if(C.forEach(e=>{let r=(e.width||0)*(e.scaleX||1),s=(e.height||0)*(e.scaleY||1);r*s>t*l&&(t=r,l=s,a=e)}),t>0&&l>0){let r=.9*Math.min(T.width/t,T.height/l),s=(T.width-t*r)/2,i=(T.height-l*r)/2,n=s-((null==a?void 0:a.x)||0)*r,o=i-((null==a?void 0:a.y)||0)*r;e.scale({x:r,y:r}),e.position({x:n,y:o}),e.batchDraw(),q({scale:r,x:n,y:o}),console.log("Max Out: Fit satellite image (".concat(Math.round(t),"x").concat(Math.round(l),"px) in viewport (").concat(T.width,"x").concat(T.height,"px) at ").concat(Math.round(100*r),"% zoom"));return}}let t=.9*Math.min(T.width/I,T.height/I),l=(T.width-I*t)/2,a=(T.height-I*t)/2;e.scale({x:t,y:t}),e.position({x:l,y:a}),e.batchDraw(),q({scale:t,x:l,y:a}),console.log("Max Out: Fit entire canvas (".concat(I,"px) in viewport (").concat(T.width,"x").concat(T.height,"px) at ").concat(Math.round(100*t),"% zoom"))},className:"px-3 py-1 bg-white border border-gray-300 rounded shadow hover:bg-gray-50 text-sm text-gray-900 text-center",title:"Fit Entire Satellite Image in View",children:"Max Out"})]}),(0,a.jsx)("button",{onClick:()=>R(!W),className:"px-3 py-1 border rounded shadow text-sm ".concat(W?"bg-blue-500 text-white border-blue-500":"bg-white text-gray-700 border-gray-300 hover:bg-gray-50"),title:"Toggle Grid",children:"Grid"}),(0,a.jsx)("button",{onClick:()=>B(!0),className:"px-3 py-1 bg-white border border-gray-300 rounded shadow hover:bg-gray-50 text-sm text-gray-900",title:"Manage Background Images",children:"Images"}),(0,a.jsx)("button",{onClick:()=>O(!G),className:"px-3 py-1 border rounded shadow text-sm ".concat(G?"bg-green-500 text-white border-green-500":"bg-white text-gray-700 border-gray-300 hover:bg-gray-50"),title:"Toggle Scale Bar",children:"Scale"}),(0,a.jsxs)("div",{className:"flex space-x-1",children:[(0,a.jsx)("button",{onClick:()=>{J?(en(null),H(!1)):(en({id:Date.now().toString(),firstPoint:null,secondPoint:null,isComplete:!1}),H(!0)),es(!1)},className:"px-3 py-1 border rounded shadow text-sm transition-colors ".concat(J&&!er?"bg-orange-500 text-white border-orange-500":"bg-white text-gray-900 border-gray-300 hover:bg-gray-50"),title:"Start New Measurement",children:"\uD83D\uDCCF Measure"}),(0,a.jsx)("button",{onClick:()=>{(null==ei?void 0:ei.isComplete)&&es(!er)},disabled:!(null==ei?void 0:ei.isComplete),className:"px-3 py-1 border rounded shadow text-sm transition-colors ".concat(er?"bg-blue-500 text-white border-blue-500":(null==ei?void 0:ei.isComplete)?"bg-white text-gray-900 border-gray-300 hover:bg-gray-50":"bg-gray-200 text-gray-400 border-gray-200 cursor-not-allowed"),title:"Edit Measurement Line",children:"✏️ Edit"}),(0,a.jsx)("button",{onClick:()=>{(null==ei?void 0:ei.isComplete)&&ec(!0)},disabled:!(null==ei?void 0:ei.isComplete),className:"px-3 py-1 border rounded shadow text-sm transition-colors ".concat((null==ei?void 0:ei.isComplete)?"bg-white text-gray-900 border-gray-300 hover:bg-gray-50":"bg-gray-200 text-gray-400 border-gray-200 cursor-not-allowed"),title:"Calibrate Scale",children:"\uD83C\uDFAF Calibrate"})]}),(0,a.jsxs)("div",{className:"flex space-x-1",children:[(0,a.jsx)("button",{onClick:()=>Q("area"===_?null:"area"),className:"px-3 py-2 rounded text-sm font-medium transition-colors ".concat("area"===_?"bg-green-500 text-white":"bg-white text-gray-700 border border-gray-300 hover:bg-gray-50"),title:"Area Measurement Tool",children:"\uD83D\uDCD0 Area"}),(0,a.jsx)("button",{onClick:()=>Q("perimeter"===_?null:"perimeter"),className:"px-3 py-2 rounded text-sm font-medium transition-colors ".concat("perimeter"===_?"bg-blue-500 text-white":"bg-white text-gray-700 border border-gray-300 hover:bg-gray-50"),title:"Perimeter Measurement Tool",children:"\uD83D\uDCCF Perimeter"}),(0,a.jsx)("button",{onClick:()=>Q("distance"===_?null:"distance"),className:"px-3 py-2 rounded text-sm font-medium transition-colors ".concat("distance"===_?"bg-amber-500 text-white":"bg-white text-gray-700 border border-gray-300 hover:bg-gray-50"),title:"Distance Measurement Tool",children:"\uD83D\uDCCF Distance"})]})]}),(0,a.jsxs)(s.BI,{ref:E,width:T.width,height:T.height,draggable:!J&&!_,onWheel:ed,onDragEnd:eu,onClick:ev,onDblClick:ek,className:"border border-gray-300 bg-gray-50 flex-1",onContentMouseDown:()=>{if(E.current&&F){let e=E.current.container();e&&(console.log("Stage mounted, capturing canvas element:",e),F(e))}},children:[(0,a.jsxs)(s.Wd,{children:[(0,a.jsx)(x,{images:C,onImageUpdate:S,onImageDelete:D,onImageSelect:eC,selectedImageId:X,scale:Y.scale,editable:!0,measurementToolActive:J||!!_}),(0,a.jsx)(i,{width:I,height:I,scale:Y.scale,x:Y.x,y:Y.y,visible:W,gridSize:10})]}),(0,a.jsx)(s.Wd,{children:(0,a.jsx)(c,{equipment:d,equipmentDefinitions:u,scale:Y.scale,onEquipmentSelect:h,onEquipmentMove:g,onEquipmentRotate:m,onEquipmentDelete:f,selectedEquipmentId:N,snapToGrid:!0,gridSize:10})}),(0,a.jsxs)(s.Wd,{children:[(0,a.jsx)(v,{isActive:J&&!_,editMode:er,scale:Y.scale,pixelsPerFoot:10,currentMeasurement:ei,onPointSet:ef,onMeasurementComplete:e=>{console.log("Enhanced measurement completed:",e)},onMeasurementEdit:eb}),(0,a.jsx)(y,{isActive:!1,scale:Y.scale,pixelsPerFoot:10,onMeasurementComplete:e=>{Z(t=>[...t,e]),console.log("New measurement:",e)},onShowDistanceInput:(e,t,l)=>{ea({calculatedDistance:e,onSubmit:l=>{((e,t)=>{let l=e/t;C.forEach(e=>{S&&S(e.id,{scaleX:e.scaleX*l,scaleY:e.scaleY*l})}),console.log("Scale calibrated: ".concat(l.toFixed(3),"x correction applied to ").concat(C.length," background images"))})(l,e),t(l),et(!1),ea(null)},onCancel:()=>{l(),et(!1),ea(null)}}),et(!0)}}),(0,a.jsx)(j,{activeTool:_,scale:Y.scale,pixelsPerFoot:10,measurements:K,onMeasurementComplete:e=>{$(t=>[...t,e])},onMeasurementDelete:e=>{$(t=>t.filter(t=>t.id!==e))}}),G&&(0,a.jsx)(p,{scale:Y.scale,canvasWidth:T.width,canvasHeight:T.height,pixelsPerFoot:10})]})]}),(0,a.jsx)(b,{images:C,onImageAdd:eN,onImageUpdate:S||(()=>{}),onImageDelete:D||(()=>{}),onImageSelect:eC,selectedImageId:X,isOpen:A,onClose:()=>B(!1)}),(0,a.jsx)(w,{isOpen:ee,calculatedDistance:(null==el?void 0:el.calculatedDistance)||0,onSubmit:(null==el?void 0:el.onSubmit)||(()=>{}),onCancel:(null==el?void 0:el.onCancel)||(()=>{})}),(0,a.jsx)(k,{isOpen:eo,calculatedDistance:ei&&ei.firstPoint&&ei.secondPoint?Math.sqrt(Math.pow(ei.secondPoint.x-ei.firstPoint.x,2)+Math.pow(ei.secondPoint.y-ei.firstPoint.y,2))/10:0,onSubmit:ep,onEdit:ey,onCancel:ew})]}):(0,a.jsx)("div",{className:"relative w-full h-full ".concat(n," flex items-center justify-center bg-gray-50"),children:(0,a.jsx)("div",{className:"text-gray-500",children:"Loading canvas..."})})}}}]);